// P√°gina p√∫blica de auto-cadastro PIX Autom√°tico
app.get('/pix-automatic-signup/:linkId', async (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIX Autom√°tico - Auto-Cadastro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div id="loading-state" class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
            <p class="text-gray-600">Carregando informa√ß√µes...</p>
        </div>
        <div id="error-state" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 text-center">
            <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Link Inv√°lido ou Expirado</h2>
            <p id="error-message" class="text-gray-600 mb-6"></p>
        </div>
        <div id="form-state" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-6">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-robot text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">PIX Autom√°tico</h1>
                <p class="text-gray-600">D√©bito Autom√°tico Mensal</p>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 mb-6 border border-blue-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600 font-medium">Valor Mensal:</span>
                    <span id="plan-value" class="text-2xl font-bold text-blue-600">R$ 0,00</span>
                </div>
                <p id="plan-description" class="text-sm text-gray-600 mb-3"></p>
                <p id="plan-frequency" class="text-xs text-gray-500"></p>
                <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-gray-700">
                        <i class="fas fa-info-circle text-yellow-600 mr-1"></i>
                        <strong>PIX Autom√°tico:</strong> Voc√™ autoriza UMA VEZ e o d√©bito ocorre automaticamente todo m√™s. Sem necessidade de pagar manualmente.
                    </p>
                </div>
            </div>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1 text-indigo-500"></i>Nome Completo
                    </label>
                    <input type="text" id="customer-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Jo√£o da Silva" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-1 text-indigo-500"></i>E-mail
                    </label>
                    <input type="email" id="customer-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="joao@email.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card mr-1 text-indigo-500"></i>CPF
                    </label>
                    <input type="text" id="customer-cpf" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="000.000.000-00" maxlength="14" required>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-lg hover:from-blue-700 hover:to-purple-700">
                    <i class="fas fa-robot mr-2"></i>Gerar Autoriza√ß√£o PIX Autom√°tico
                </button>
            </form>
        </div>
        <div id="success-state" class="hidden max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-6">
                <div class="bg-blue-500 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                    <i class="fas fa-robot text-white text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Autoriza√ß√£o PIX Autom√°tico Criada!</h2>
                <p class="text-gray-600">Escaneie o QR Code para autorizar o d√©bito autom√°tico</p>
            </div>
            <div class="bg-white border-2 border-blue-300 rounded-xl p-6 mb-6">
                <div id="qr-code-container" class="flex justify-center mb-4">
                    <img id="qr-code-image" src="" alt="QR Code PIX Autom√°tico" class="w-64 h-64 border-4 border-white shadow-lg rounded-lg">
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600 mb-2">Pix Copia e Cola:</p>
                    <div class="flex gap-2">
                        <input type="text" id="pix-payload" readonly class="flex-1 text-xs bg-white border border-gray-300 rounded px-3 py-2 font-mono">
                        <button onclick="copyPixPayload()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-3">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    Como funciona?
                </h3>
                <ol class="text-sm text-gray-700 space-y-2">
                    <li><strong>1.</strong> Escaneie o QR Code com o app do seu banco</li>
                    <li><strong>2.</strong> Autorize o d√©bito autom√°tico UMA VEZ</li>
                    <li><strong>3.</strong> Pague a primeira parcela imediatamente</li>
                    <li><strong>4.</strong> Autoriza√ß√£o ser√° ativada ap√≥s o pagamento</li>
                    <li><strong>5.</strong> Todo m√™s o valor ser√° debitado automaticamente</li>
                </ol>
            </div>
        </div>
        
        <!-- Payment Confirmed State -->
        <div id="payment-confirmed-state" class="hidden max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 animate-pulse-slow">
            <div class="text-center mb-6">
                <div class="bg-gradient-to-r from-green-400 to-emerald-500 w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce shadow-2xl">
                    <i class="fas fa-check-double text-white text-5xl"></i>
                </div>
                <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-600 mb-3 animate-pulse">üéâ Pagamento Confirmado! üéâ</h2>
                <p class="text-xl text-green-600 font-semibold mb-4">‚úÖ Sua assinatura foi ativada com sucesso</p>
            </div>
            
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 mb-6 border-2 border-green-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">
                    <i class="fas fa-calendar-check text-green-600 mr-2"></i>
                    O que acontece agora?
                </h3>
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-4 flex-shrink-0 font-bold">1</div>
                        <div>
                            <p class="font-semibold text-gray-800">Pagamento Processado</p>
                            <p class="text-sm text-gray-600">Seu pagamento foi confirmado e registrado</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-4 flex-shrink-0 font-bold">2</div>
                        <div>
                            <p class="font-semibold text-gray-800">Autoriza√ß√£o Ativa</p>
                            <p class="text-sm text-gray-600">Seu d√©bito autom√°tico est√° ativo a partir de agora</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-4 flex-shrink-0 font-bold">3</div>
                        <div>
                            <p class="font-semibold text-gray-800">Cobran√ßas Autom√°ticas</p>
                            <p class="text-sm text-gray-600">Todo m√™s o valor ser√° debitado automaticamente - VOC√ä N√ÉO PRECISA FAZER NADA!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                <p class="text-sm text-gray-700">
                    <i class="fas fa-envelope text-blue-500 mr-2"></i>
                    Voc√™ receber√° um email de confirma√ß√£o em breve
                </p>
            </div>
        </div>
    </div>
    <script>
        const pathParts = window.location.pathname.split('/');
        const linkId = pathParts[pathParts.length - 1];
        let linkData = null;
        
        async function loadLinkData() {
            try {
                const response = await axios.get(\`/api/pix/automatic-signup-link/\${linkId}\`);
                if (response.data.ok) {
                    linkData = response.data.data;
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('form-state').classList.remove('hidden');
                    document.getElementById('plan-value').textContent = \`R$ \${linkData.value.toFixed(2)}\`;
                    document.getElementById('plan-description').textContent = linkData.description;
                    document.getElementById('plan-frequency').textContent = \`Frequ√™ncia: \${linkData.frequency === 'MONTHLY' ? 'Mensal' : linkData.frequency}\`;
                } else {
                    showError(response.data.error || 'Link inv√°lido');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Erro ao carregar');
            }
        }
        
        function showError(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('form-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
        
        document.getElementById('customer-cpf').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 9) {
                value = value.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\\d{3})(\\d{3})(\\d{1,3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\\d{3})(\\d{1,3})/, '$1.$2');
            }
            e.target.value = value;
        });
        
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Criando...';
            
            try {
                const response = await axios.post(\`/api/pix/automatic-signup/\${linkId}\`, {
                    customerName: document.getElementById('customer-name').value,
                    customerEmail: document.getElementById('customer-email').value,
                    customerCpf: document.getElementById('customer-cpf').value.replace(/\\D/g, '')
                });
                
                if (response.data.ok) {
                    document.getElementById('form-state').classList.add('hidden');
                    document.getElementById('success-state').classList.remove('hidden');
                    if (response.data.qrCode) {
                        document.getElementById('qr-code-image').src = response.data.qrCode.encodedImage;
                        document.getElementById('pix-payload').value = response.data.qrCode.payload;
                    }
                    
                    // Iniciar verifica√ß√£o de pagamento
                    window.authorizationId = response.data.authorization.id;
                    startPaymentCheck();
                } else {
                    alert('Erro: ' + response.data.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-robot mr-2"></i>Gerar Autoriza√ß√£o PIX Autom√°tico';
                }
            } catch (error) {
                alert('Erro: ' + (error.response?.data?.error || error.message));
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-robot mr-2"></i>Gerar Autoriza√ß√£o PIX Autom√°tico';
            }
        });
        
        function copyPixPayload() {
            const payload = document.getElementById('pix-payload');
            payload.select();
            document.execCommand('copy');
            alert('PIX copiado!');
        }
        
        // Verificar status da autoriza√ß√£o/pagamento a cada 10 segundos
        let checkInterval;
        function startPaymentCheck() {
            checkInterval = setInterval(async () => {
                try {
                    // TODO: Implementar verifica√ß√£o de status da autoriza√ß√£o
                    // Por enquanto, apenas simula
                    console.log('Verificando status da autoriza√ß√£o...');
                } catch (error) {
                    console.error('Erro ao verificar autoriza√ß√£o:', error);
                }
            }, 10000); // Verifica a cada 10 segundos
        }
        
        function showPaymentConfirmed() {
            clearInterval(checkInterval);
            document.getElementById('success-state').classList.add('hidden');
            document.getElementById('payment-confirmed-state').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        loadLinkData();
    </script>
</body>
</html>`)
})
